#!/bin/bash
set -eu

# Output list of users for which DUC Database file is slightly over that generated by
# users who have never logged in
function mk_datalist() {
  for user in $( /root/bin/get_users ); do
    db_file=/home/$user/.duc.db

    if [ -f $db_file ] && [[ $(stat -c%s $db_file ) -gt 270000 ]]; then
      echo "  <option>$user</option>"
     fi
  done
}

datalist="$( mk_datalist | sort )"

#sed "s:DATALIST:${datalist}:g" /srv/diskusage/header.template.html

echo > /tmp/diskusage.tmp
cat >> /tmp/diskusage.tmp << EOF
<div style="width:950px">
<h1>
<a href="mailto:cardiff-igwn-cluster-help@cf.onmicrosoft.com">&#9993; Help</a>
<a href="/diskusage/">‚õÅ Home</a>
User: USER
<a href="/diskusage/USER/sizes/?QUERY">File sizes</a>
<a href="/diskusage/USER/count/?QUERY">File count</a>
<input style="float:right"
       placeholder="Switch User..."
       list="users"
       onchange="window.location.href = '/diskusage/' + this.value + '/';">

<datalist id="users">
EOF

echo "${datalist}"  >> /tmp/diskusage.tmp
echo '</datalist>
</h1>
</div>'  >> /tmp/diskusage.tmp

# If nothing has failed, then make the switch
mv /tmp/diskusage.tmp /srv/diskusage/header.html


